<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Clarity ¬∑ Sigrid ‚Äî Focus + Reliable Tones ‚ùÑÔ∏è</title>

<!-- iPhone / PWA Dark Theme -->
<meta name="theme-color" content="#0b0d11">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0d11">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clarity ¬∑ Sigrid">
<meta name="description" content="One-video focus (loop) + reliable 160/162 Hz binaural with 512 Hz shimmer. Jellyfish pulse, AURORA Morse hint, and a 2:22 ¬∑ 1:28 ¬∑ 0:42 puzzle.">

<style>
/* ---- Dark iPhone theme foundation ---- */
:root{
  color-scheme: dark;
  --bg:#0b0d11; --bg-top:#0a0e16; --ink:#eaf9ff; --muted:#9fb4c2;
  --card:#0f1621; --ring:#182232; --accent:#9ed0ff; --ok:#89f7d6; --halo:#bee4ff;
  --gradA:#111827; --gradB:#0b0d11; --tap: rgba(158,208,255,.15);
  --shadow: 0 0 0 1px #1a2436 inset, 0 10px 30px rgba(0,0,0,.35);
  --gold:#ffd27a;
}
*{box-sizing:border-box}
html,body{height:100%}
html{background:#000}
body{
  margin:0; color:var(--ink);
  background:radial-gradient(1200px 800px at 50% -10%, var(--gradA) 0%, var(--gradB) 55%);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  padding-top: calc(env(safe-area-inset-top, 0px) + 6px);
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
  -webkit-text-size-adjust: 100%;
}
*{-webkit-tap-highlight-color: transparent}
:focus-visible{outline:2px solid var(--accent); outline-offset:2px}

.ios-top,.ios-bottom{position:fixed; left:0; right:0; z-index:5; pointer-events:none}
.ios-top{ top:0; height: env(safe-area-inset-top, 0px); background:linear-gradient(#070b12,#0b0d11)}
.ios-bottom{ bottom:0; height: env(safe-area-inset-bottom, 0px); background:linear-gradient(#0b0d11,#090d14)}

.header{padding:2.2rem 1rem 1rem; text-align:center}
h1{margin:0 0 .25rem; font-weight:700; letter-spacing:.02em}
.tag{color:var(--muted); font-size:.95rem}
.wrap{max-width:980px; margin:0 auto; padding:0 1rem 4rem}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border:1px solid var(--ring); border-radius:16px; padding:1rem; margin:1rem 0;
  backdrop-filter: blur(7px);
  box-shadow: var(--shadow);
}
.row{display:flex; flex-wrap:wrap; gap:.65rem; align-items:center}

/* buttons & controls */
button{
  border:0; border-radius:14px; padding:.9rem 1.2rem; font-weight:650; cursor:pointer;
  background:var(--accent); color:#071018; transition:transform .06s ease, opacity .18s ease, box-shadow .2s ease, filter .2s ease;
}
button:active{transform:translateY(1px)}
button.ghost{background:rgba(255,255,255,0.02); color:var(--ink); border:1px solid var(--ring)}
button.ghost:active{background:var(--tap)}
label.toggle{display:inline-flex; align-items:center; gap:.5rem}
input[type="checkbox"]{width:1.1rem; height:1.1rem; accent-color: var(--accent)}
.small{font-size:.92rem; color:var(--muted)}
.timer{
  font-variant-numeric:tabular-nums; font-weight:750; letter-spacing:.02em;
  background:#0d1522; border:1px solid var(--ring); padding:.5rem .7rem; border-radius:10px;
}
.slider{appearance:none; width:160px; height:6px; border-radius:999px; background:#1a2740; outline:none}
.slider::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); border:1px solid #0c1628}
.sep{height:1px; background:linear-gradient(90deg,transparent,#21304a,transparent); border:0; margin:1rem 0}

/* focus player */
.player{position:relative; border-radius:14px; overflow:hidden; border:1px solid var(--ring); aspect-ratio:16/9; background:#0d1522; margin-top:.75rem}
.player iframe{position:absolute; inset:0; width:100%; height:100%; border:0; border-radius:14px}

/* tracklist */
.list{display:grid; grid-template-columns:1fr; gap:.4rem; margin-top:.75rem}
.track{
  display:flex; gap:.6rem; align-items:center; justify-content:space-between;
  padding:.6rem .8rem; border:1px solid var(--ring); border-radius:10px; background:#0d1522; color:var(--ink);
}
.track button{padding:.45rem .7rem; border-radius:10px; font-size:.9rem; background:#1a2740; color:var(--accent)}
.track .t{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%}
.active{outline:2px solid var(--accent); box-shadow:0 0 0 2px rgba(158,208,255,.25) inset}

.footer{color:var(--muted); text-align:center; padding:1.25rem}
.ribbon{
  position:fixed; top: calc(env(safe-area-inset-top, 0px) + .35rem);
  left:50%; transform:translateX(-50%); z-index:6;
  display:flex; gap:.5rem; background:rgba(9,14,22,.88); border:1px solid var(--ring);
  padding:.35rem .5rem; border-radius:999px; backdrop-filter:blur(10px)
}
.ribbon a{display:inline-block; padding:.45rem .75rem; border-radius:999px; background:#0d1522; border:1px solid var(--ring); color:var(--accent); text-decoration:none; font-weight:650; font-size:.92rem}

/* animated Start */
#start{position:relative; isolation:isolate; box-shadow:0 0 0 0 rgba(158,208,255,.6), inset 0 0 12px rgba(255,255,255,.15)}
#start::before,#start::after{
  content:""; position:absolute; inset:-8px; border-radius:18px; z-index:-1;
  background:conic-gradient(from 0deg, transparent 0 30%, rgba(158,208,255,.25) 40% 60%, transparent 70% 100%);
  filter:blur(12px); animation:spin 6s linear infinite;
}
#start::after{inset:-14px; opacity:.6; animation-duration:9s; filter:blur(20px)}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(158,208,255,.45)}70%{box-shadow:0 0 0 18px rgba(158,208,255,0)}100%{box-shadow:0 0 0 0 rgba(158,208,255,0)}}
#start.pulsing{animation:pulse 2.4s ease-out infinite}
.spark{position:absolute; pointer-events:none; width:8px; height:8px; border-radius:50%; background:#eaf9ff; filter:drop-shadow(0 0 12px var(--halo)); opacity:.95; animation:spark .6s ease-out forwards}
@keyframes spark{to{transform:translate(var(--dx),var(--dy)) scale(.2); opacity:0}}

/* tone meters + honey-thread class */
.meterRow{display:flex; gap:.5rem; align-items:center; margin-top:.5rem; flex-wrap:wrap}
.meter{height:8px; width:110px; background:#162236; border:1px solid #24324a; border-radius:999px; overflow:hidden}
.fill{height:100%; width:0%; background:linear-gradient(90deg,#89f7d6,#9ed0ff); box-shadow:0 0 8px rgba(137,247,214,.35)}
.honey .fill{background:linear-gradient(90deg,#ffd27a,#9ed0ff); box-shadow:0 0 10px rgba(255,210,122,.35)}
.badge{font-size:.82rem; color:var(--muted)}

/* jellyfish glyph */
.jelly{
  width:62px; height:62px; border-radius:50%;
  background:radial-gradient(60% 60% at 50% 45%, rgba(158,208,255,.45), rgba(158,208,255,.08) 70%, transparent 71%);
  border:1px solid #21324a; box-shadow:0 0 18px rgba(158,208,255,.15);
  position:relative; margin-left:.4rem;
  transition:filter .25s ease, box-shadow .25s ease, border-color .25s ease;
}
.jelly:after, .jelly:before{
  content:""; position:absolute; left:50%; transform:translateX(-50%);
  width:36px; height:12px; bottom:-4px;
  background: radial-gradient(50% 100% at 50% 0%, rgba(158,208,255,.28), transparent 70%);
  filter:blur(4px);
}
.jelly:before{width:44px; bottom:-8px; opacity:.6}
.honey .jelly{border-color:#3a2a1e; box-shadow:0 0 18px rgba(255,210,122,.14)}
/* morse line */
.morse{height:3px; width:100%; background:#19253a; border-radius:999px; overflow:hidden; margin-top:.6rem; position:relative}
.morse .blink{position:absolute; top:0; left:0; height:100%; width:0%; background:#9ed0ff; box-shadow:0 0 10px rgba(158,208,255,.6)}
.honey .morse .blink{background:var(--gold); box-shadow:0 0 10px rgba(255,210,122,.6)}

/* puzzle bells */
.bells{display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; margin-top:.6rem}
.bell{display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .6rem; border:1px solid var(--ring); border-radius:999px; background:#0d1522; color:var(--ink); font-size:.92rem; user-select:none; cursor:pointer}
.bell[data-hit="1"]{background:rgba(255,210,122,.12); border-color:#3a2a1e}
.reveal{display:none; margin-top:.6rem; padding:.6rem .75rem; border:1px solid var(--ring); border-radius:10px; background:#101827}
.reveal.show{display:block}
</style>
</head>
<body>
<div class="ios-top"></div><div class="ios-bottom"></div>

<nav class="ribbon">
  <a href="https://jar.plnt.earth" target="_self" rel="noopener">‚Ü© Jar</a>
  <a href="https://tunes.plnt.earth" target="_self" rel="noopener">üéµ Tunes</a>
</nav>

<header class="header">
  <h1>‚ùÑÔ∏è Sigrid ‚Äî Clarity Focus</h1>
  <div class="tag">iPhone-dark, reliable 160/162 Hz binaural + one inline video loop. Tap Start to unlock audio.</div>
</header>

<main class="wrap">
  <section class="card" aria-label="controls">
    <div class="row">
      <button id="start" class="pulsing">‚ñ∂ Start Session</button>
      <button id="stop" class="ghost" disabled>‚è∏ Stop</button>
      <span class="timer" id="clock">03:00</span>

      <label class="toggle"><input type="checkbox" id="shimmer"> <span>512 Hz shimmer</span></label>
      <label class="toggle"><input type="checkbox" id="softfade" checked> <span>Soft fade</span></label>

      <label class="toggle"><input type="checkbox" id="mute" checked> <span>Muted</span></label>
      <span class="small">Volume</span><input id="vol" type="range" min="0" max="100" value="40" class="slider" />

      <button id="prev" class="ghost">‚üµ Prev</button>
      <button id="next" class="ghost">Next ‚ü∂</button>
      <button id="focus" class="ghost">‚≠ê Focus ‚ÄúStrangers‚Äù</button>
      <button id="resync" class="ghost">‚ü≤ Re-init Audio</button>

      <!-- Jellyfish glyph (pulse driven by meters) -->
      <div id="jelly" class="jelly" aria-label="Northlight jelly ‚Äî pulses with tone"></div>
    </div>

    <div class="meterRow">
      <span class="badge">Left 160 Hz</span><div class="meter"><div id="mL" class="fill"></div></div>
      <span class="badge">Right 162 Hz</span><div class="meter"><div id="mR" class="fill"></div></div>
      <span class="badge" id="state">Locked</span>
    </div>

    <!-- Puzzle: bells at 2:22 ¬∑ 1:28 ¬∑ 0:42 -->
    <div class="bells" role="group" aria-label="Northlight bells puzzle">
      <div class="bell" data-target="142">üîî 2:22</div>
      <div class="bell" data-target="88">üîî 1:28</div>
      <div class="bell" data-target="42">üîî 0:42</div>
    </div>
    <div id="reveal" class="reveal">üóùÔ∏è <strong>Northlight Note</strong>: ‚ÄúBreathe the truth in. Exhale what isn‚Äôt yours.‚Äù  
      Bridge key ‚Üí <code>512</code>. If honey glows, follow the mirror.</div>

    <p class="small" style="margin:.5rem 0 0">First run tips (iPhone): volume up, ringer ON, keep screen on ~15s after start. If tone drops after backgrounding ‚Üí ‚ÄúRe-init Audio‚Äù.</p>
  </section>

  <section class="card" aria-label="player">
    <div class="player">
      <iframe id="yt" title="Sigrid ‚Äî player" allow="autoplay; encrypted-media" allowfullscreen playsinline></iframe>
    </div>

    <!-- Morse hint line: AURORA -->
    <div class="morse" aria-hidden="true"><div id="blink" class="blink"></div></div>
    <div class="small" style="margin-top:.35rem">hint: ¬∑ = short blink, ‚Äì = long ‚Äî listen for the bell.</div>

    <hr class="sep">
    <div class="list" id="tracklist"></div>
  </section>
</main>

<footer class="footer">clarity.plnt.earth ‚Äî iPhone-Dark ¬∑ Focus + Reliable Tones ¬∑ Headphones recommended</footer>

<script>
/* ---------------- Playlist ---------------- */
var TRACKS = [
  {t:'Strangers', id:'tEddixS-UoU'},
  {t:"Don‚Äôt Kill My Vibe", id:'jJo0MT3wDBs'},
  {t:'Sight of You', id:'ff6KPrgZx8k'},
  {t:'Sucker Punch', id:'KscadEpooPo'},
  {t:'High Five', id:'UxxajLWwzqY'},
  {t:'Mirror', id:'kfwf3H0IflU'},
  {t:'Burning Bridges', id:'HkWlV6j5H5w'},
  {t:'It Gets Dark', id:'2LhJYv8pY-E'},
  {t:'Home To You (Like A Bullet)', id:'rX8FHkXoFfE'},
  {t:'Head On Fire (with Griff)', id:'5jJzy6TIT3w'},
  {t:'Plot Twist', id:'lYPzRy2b08E'},
  {t:'Dynamite (acoustic)', id:'JtTQ_7U3V6E'}
];

/* ---------------- YouTube embed (no external API) ---------------- */
var player = document.getElementById('yt');
var current = 0;
function buildSrc(id, muted) {
  var base = 'https://www.youtube.com/embed/'+id;
  var q = [
    'autoplay=1','mute='+(muted?1:0),
    'loop=1','playlist='+id,'controls=0',
    'playsinline=1','modestbranding=1','rel=0','enablejsapi=1'
  ].join('&');
  return base+'?'+q;
}
function send(func, args){
  try{ player.contentWindow.postMessage(JSON.stringify({event:'command', func:func, args:args||[]}), '*'); }catch(e){}
}
function setVol(v){ send('setVolume', [Math.max(0,Math.min(100, v))]); }
function loadIndex(i, keepMute){
  current = (i+TRACKS.length)%TRACKS.length;
  var id = TRACKS[current].id;
  player.src = buildSrc(id, true); // start muted for autoplay reliability
  highlight();
  setTimeout(function(){
    send('playVideo');
    if(!keepMute && !MUTE.checked){ send('unMute'); setVol(parseInt(VOL.value,10)||40); }
  }, 450);
}

/* ---------------- Tone engine with iOS unlock + meters ---------------- */
var ctx,leftOsc,rightOsc,shimOsc,lGain,rGain,sGain,merger,analyserL,analyserR,splitter,vuTimer=null;
var stateBadge=document.getElementById('state'), mL=document.getElementById('mL'), mR=document.getElementById('mR');
var jelly=document.getElementById('jelly');

function ramp(p,to,t){ try{p.linearRampToValueAtTime(to,t);}catch(e){} }

function unlockAudioOnce(){
  try{
    var src = ctx.createBufferSource();
    src.buffer = ctx.createBuffer(1, 1, ctx.sampleRate);
    src.connect(ctx.destination); src.start(0); src.stop(0);
  }catch(e){}
}

function startTone(){
  if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)(); }
  if(ctx.state === 'suspended'){ ctx.resume(); }
  unlockAudioOnce();

  var now = ctx.currentTime;

  leftOsc = ctx.createOscillator(); rightOsc = ctx.createOscillator();
  lGain = ctx.createGain(); rGain = ctx.createGain();

  leftOsc.type='sine'; rightOsc.type='sine';
  leftOsc.frequency.setValueAtTime(160, now);
  rightOsc.frequency.setValueAtTime(162, now);

  lGain.gain.setValueAtTime(0.0001, now);
  rGain.gain.setValueAtTime(0.0001, now);

  merger = ctx.createChannelMerger(2);
  splitter = ctx.createChannelSplitter(2);
  analyserL = ctx.createAnalyser(); analyserR = ctx.createAnalyser();
  analyserL.fftSize = 256; analyserR.fftSize = 256;

  leftOsc.connect(lGain).connect(merger,0,0);
  rightOsc.connect(rGain).connect(merger,0,1);

  merger.connect(splitter);
  splitter.connect(analyserL, 0);
  splitter.connect(analyserR, 1);

  var out = ctx.createGain();
  merger.connect(out).connect(ctx.destination);

  var fade = SOFT.checked ? 2.0 : 0.05;
  ramp(lGain.gain, 0.08, now + fade);
  ramp(rGain.gain, 0.08, now + fade);

  leftOsc.start(); rightOsc.start();

  if(SHIM.checked){
    shimOsc = ctx.createOscillator(); sGain = ctx.createGain();
    shimOsc.type='sine'; shimOsc.frequency.setValueAtTime(512, now);
    sGain.gain.setValueAtTime(0.0001, now);
    ramp(sGain.gain, 0.03, now + fade);
    shimOsc.connect(sGain).connect(ctx.destination); shimOsc.start();
  }

  // meters + jelly pulse
  if(vuTimer){ cancelAnimationFrame(vuTimer); vuTimer=null; }
  function vu(){
    if(!analyserL || !analyserR){ return; }
    var bufL = new Uint8Array(analyserL.frequencyBinCount);
    var bufR = new Uint8Array(analyserR.frequencyBinCount);
    analyserL.getByteTimeDomainData(bufL);
    analyserR.getByteTimeDomainData(bufR);
    var pkL=0, pkR=0;
    for(var i=0;i<bufL.length;i++){ pkL = Math.max(pkL, Math.abs(bufL[i]-128)); }
    for(var j=0;j<bufR.length;j'){ pkR = Math.max(pkR, Math.abs(bufR[j]-128)); }
    var wl = Math.min(100, Math.round(pkL/128*100));
    var wr = Math.min(100, Math.round(pkR/128*100));
    mL.style.width = wl+'%';
    mR.style.width = wr+'%';
    // jelly glow from average
    var avg = (wl+wr)/2;
    jelly.style.filter = 'brightness('+(1+avg/140)+')';
    vuTimer = requestAnimationFrame(vu);
  }
  vu();

  stateBadge.textContent = 'Audio: running';
}

function stopTone(){
  if(!ctx) return;
  var now = ctx.currentTime, fade = SOFT.checked ? 1.2 : 0.05;
  try{
    ramp(lGain.gain, 0.0001, now+fade);
    ramp(rGain.gain, 0.0001, now+fade);
    if(sGain) ramp(sGain.gain, 0.0001, now+fade);
    setTimeout(function(){
      try{ leftOsc.stop(); rightOsc.stop(); if(shimOsc) shimOsc.stop(); }catch(e){}
      leftOsc=rightOsc=shimOsc=null; lGain=rGain=sGain=null;
      analyserL=analyserR=splitter=null;
      if(vuTimer){ cancelAnimationFrame(vuTimer); vuTimer=null; }
      mL.style.width='0%'; mR.style.width='0%';
      jelly.style.filter='brightness(1)';
      stateBadge.textContent = 'Audio: stopped';
    }, Math.ceil(fade*1000)+80);
  }catch(e){}
}

function reinitAudio(){ stopTone(); setTimeout(startTone, 140); }

/* ---------------- UI wiring ---------------- */
var START=document.getElementById('start');
var STOP=document.getElementById('stop');
var SHIM=document.getElementById('shimmer');
var SOFT=document.getElementById('softfade');
var MUTE=document.getElementById('mute');
var VOL=document.getElementById('vol');
var PREV=document.getElementById('prev');
var NEXT=document.getElementById('next');
var FOCUS=document.getElementById('focus');
var RESYNC=document.getElementById('resync');
var CLOCK=document.getElementById('clock');
var LIST=document.getElementById('tracklist');
var running=false, timerId=null;

function spark(x,y){
  var host=START.parentElement;
  for(var i=0;i<10;i++){
    var s=document.createElement('div'); s.className='spark';
    var ang=Math.random()*Math.PI*2; var dist=30+Math.random()*40;
    s.style.left=(x - host.getBoundingClientRect().left - 4)+'px';
    s.style.top=(y - host.getBoundingClientRect().top - 4)+'px';
    s.style.setProperty('--dx', Math.cos(ang)*dist+'px');
    s.style.setProperty('--dy', Math.sin(ang)*dist+'px');
    host.appendChild(s); (function(el){ setTimeout(function(){ if(el && el.parentNode) el.parentNode.removeChild(el); }, 620); })(s);
  }
}

/* Build track list */
function buildList(){
  LIST.innerHTML='';
  for(var i=0;i<TRACKS.length;i++){
    (function(idx){
      var row=document.createElement('div'); row.className='track'; row.dataset.i=idx;
      var label=document.createElement('div'); label.className='t'; label.textContent=TRACKS[idx].t;
      var play=document.createElement('button'); play.textContent='Play';
      play.addEventListener('click', function(){
        loadIndex(idx, true);
        if(!MUTE.checked){ setTimeout(function(){ send('unMute'); setVol(parseInt(VOL.value,10)||40); }, 420); }
      }, {passive:true});
      row.appendChild(label); row.appendChild(play); LIST.appendChild(row);
    })(i);
  }
}
function highlight(){
  var rows=LIST.querySelectorAll('.track');
  for(var i=0;i<rows.length;i++){ rows[i].classList.remove('active'); }
  var r=LIST.querySelector('.track[data-i="'+current+'"]'); if(r) r.classList.add('active');
}

/* Lifecycle */
function start(ev){
  if(running) return;
  running=true;

  function resumeOnce(){ try{ if(ctx && ctx.state==='suspended') ctx.resume(); }catch(e){} }
  document.body.addEventListener('pointerup', resumeOnce, {once:true, passive:true});
  document.body.addEventListener('touchend', resumeOnce, {once:true, passive:true});
  document.body.addEventListener('click', resumeOnce, {once:true, passive:true});

  startTone();
  loadIndex(current, true);
  setTimeout(function(){ if(!MUTE.checked){ send('unMute'); setVol(parseInt(VOL.value,10)||40); } }, 800);

  var until=Date.now()+180000;
  CLOCK.textContent='03:00';
  if(timerId) clearInterval(timerId);
  timerId = setInterval(function(){
    var remain=Math.max(0, Math.round((until - Date.now())/1000));
    var m=Math.floor(remain/60), s=remain%60;
    CLOCK.textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
    if(remain<=0){ clearInterval(timerId); timerId=null; stop(); }
  }, 200);

  START.disabled=true; STOP.disabled=false; START.classList.add('pulsing');
  if(ev && ev.clientX) spark(ev.clientX, ev.clientY);
}
function stop(){
  if(!running) return; running=false;
  stopTone(); send('mute'); send('pauseVideo');
  if(timerId){ clearInterval(timerId); timerId=null; }
  CLOCK.textContent='03:00'; START.disabled=false; STOP.disabled=true;
}

/* Visibility resume */
document.addEventListener('visibilitychange', function(){
  try{
    if(document.visibilityState==='visible' && ctx && ctx.state==='suspended'){
      ctx.resume(); stateBadge.textContent='Audio: resumed';
    }
  }catch(e){}
}, {passive:true});

/* Buttons */
START.addEventListener('click', start, {passive:true});
STOP.addEventListener('click', stop, {passive:true});
MUTE.addEventListener('change', function(){ if(this.checked){ send('mute'); } else { send('unMute'); setVol(parseInt(VOL.value,10)||40); }}, {passive:true});
VOL.addEventListener('input', function(){ if(!MUTE.checked){ setVol(parseInt(this.value,10)||40); }}, {passive:true});
PREV.addEventListener('click', function(){ loadIndex(current-1, true); if(!MUTE.checked){ setTimeout(function(){ send('unMute'); setVol(parseInt(VOL.value,10)||40); }, 300);} }, {passive:true});
NEXT.addEventListener('click', function(){ loadIndex(current+1, true); if(!MUTE.checked){ setTimeout(function(){ send('unMute'); setVol(parseInt(VOL.value,10)||40); }, 300);} }, {passive:true});
FOCUS.addEventListener('click', function(){
  var i = TRACKS.findIndex(function(x){ return /strangers/i.test(x.t); });
  if(i<0) i=0; loadIndex(i, true);
  if(!MUTE.checked){ setTimeout(function(){ send('unMute'); setVol(parseInt(VOL.value,10)||40); }, 420); }
}, {passive:true});
RESYNC.addEventListener('click', reinitAudio, {passive:true});

/* Shimmer ‚Üí honey thread tint */
SHIM.addEventListener('change', function(){
  document.body.classList.toggle('honey', this.checked);
  if(ctx && ctx.state==='running'){ reinitAudio(); } // re-apply shimmer gain gently
}, {passive:true});

/* Init list */
buildList(); highlight();

/* ---------------- Morse hint: AURORA ---------------- */
(function(){
  var blink = document.getElementById('blink');
  var DOT = 250, DASH = 750, GAP = 250, LETTER = 750;
  var seq = ['.-','..-','.-.','---','.-.','.-']; // A U R O R A
  var idxL=0, idxS=0;

  function run(){
    var code = seq[idxL];
    if(idxS >= code.length){
      idxS = 0; setTimeout(function(){ idxL=(idxL+1)%seq.length; run(); }, LETTER);
      return;
    }
    var sym = code[idxS]; idxS++;
    blink.style.transition = 'none'; blink.style.width = '0%';
    setTimeout(function(){
      blink.style.transition = 'width '+(sym==='.'?DOT:DASH)+'ms linear';
      blink.style.width = '100%';
      setTimeout(function(){ blink.style.transition='width 60ms linear'; blink.style.width='0%'; setTimeout(run, GAP); }, (sym==='.'?DOT:DASH));
    }, 10);
  }
  run();
})();

/* ---------------- Puzzle bells ---------------- */
(function(){
  var bells = document.querySelectorAll('.bell');
  var reveal = document.getElementById('reveal');

  function nowSec(){
    var t = (document.getElementById('clock').textContent||'03:00').split(':');
    var m = parseInt(t[0],10)||0, s=parseInt(t[1],10)||0;
    return m*60+s;
  }
  function checkWin(){
    var all = true;
    bells.forEach(function(b){ if(b.getAttribute('data-hit')!=='1') all=false; });
    if(all){ reveal.classList.add('show'); }
  }
  bells.forEach(function(btn){
    btn.addEventListener('click', function(){
      var target = parseInt(btn.getAttribute('data-target'),10);
      var diff = Math.abs(nowSec() - target);
      if(diff <= 3){ // within ¬±3s
        btn.setAttribute('data-hit','1');
        btn.innerHTML = '‚úÖ ' + btn.textContent.replace('üîî ','');
        checkWin();
      } else {
        btn.animate([{transform:'translateY(0)'},{transform:'translateY(-2px)'},{transform:'translateY(0)'}], {duration:220});
      }
    }, {passive:true});
  });
})();
</script>
</body>
</html>
