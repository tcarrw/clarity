<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Clarity · Shared Edge Sync — Mutual Seed Bursts</title>
<meta name="description" content="Mutual Seed Bursts with shared edge sync (:00/:30). Bursts loop on Sigrid tracks in Red↔Blue mode; Calm phase to settle. Advanced controls under More."/>
<meta name="theme-color" content="#0b0d11">
<meta name="color-scheme" content="dark">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="dns-prefetch" href="https://www.youtube.com">
<link rel="dns-prefetch" href="https://i.ytimg.com">
<link rel="dns-prefetch" href="https://www.google.com">
<link rel="preconnect" href="https://www.youtube.com" crossorigin>
<link rel="preconnect" href="https://i.ytimg.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>

<style>
  :root{
    --bg:#0b0d11; --ink:#e9ecf4; --muted:#9aa6b6; --card:#101425; --ring:#1b2433;
    --accent:#7fd0ff; --accent-2:#b9ffe6; --shadow:0 14px 40px rgba(3,8,14,.55);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
    color:var(--ink);
    background:
      radial-gradient(120% 120% at 20% -10%, rgba(127,208,255,.12), transparent 50%),
      radial-gradient(100% 100% at 120% 0%, rgba(185,255,230,.08), transparent 60%),
      linear-gradient(180deg,#0b0d11 0%, #0b1018 60%, #0b0d11 100%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow-x:hidden;
  }
  #stars{position:fixed; inset:0; z-index:-1; filter:drop-shadow(0 0 2px rgba(127,208,255,.25))}
  .wrap{max-width:1080px;margin:0 auto;padding:20px 14px 120px; position:relative; z-index:1}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 16px}
  .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
  .jelly{width:42px;height:42px;border-radius:14px;
    background:radial-gradient(120% 120% at 20% 10%, #11304a 0%, #0e2133 50%, #0c1624 80%) padding-box,
               conic-gradient(from 0deg at 50% 60%, #0f2236, #173a59, #123047, #0f2236) border-box;
    border:2px solid transparent; box-shadow:var(--shadow),0 0 40px rgba(127,208,255,.25) inset; position:relative; overflow:hidden}
  .jelly:after{content:"";position:absolute;left:50%;top:55%;width:70%;height:70%;transform:translate(-50%,-50%);
    filter:blur(12px); background:radial-gradient(50% 60% at 50% 40%, rgba(127,208,255,.18), transparent 70%)}
  h1{font-size:20px;margin:0}
  .small{font-size:12px;color:var(--muted)}
  .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f1827;border:1px solid var(--ring);color:#b7c6dc}

  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:var(--card);border:1px solid var(--ring);
    border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)}
  .btn{appearance:none;border:1px solid var(--ring);background:linear-gradient(180deg,#122034,#0f1b2b);color:var(--ink);
    padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer; box-shadow:var(--shadow); transition:transform .08s ease, box-shadow .2s}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#13263c,#0f1e30) padding-box, conic-gradient(from 0deg,#3bb5ff,#b9ffe6,#7fd0ff,#3bb5ff) border-box; border:1px solid transparent}
  .switch{display:inline-flex;border:1px solid var(--ring);border-radius:12px;overflow:hidden;background:#0f1b2a}
  .switch button{border:0;background:transparent;color:var(--ink);padding:8px 12px;cursor:pointer}
  .switch button.active{background:#142235;font-weight:700}
  .pill{font-size:12px;border:1px solid var(--ring);padding:4px 8px;border-radius:999px;background:#0f1b2a;color:var(--ink)}
  .pill .row{display:inline-flex;gap:8px;align-items:center}
  .badge{border:1px solid var(--ring); border-radius:999px; padding:2px 8px; font-size:12px; color:#c9d6ea}
  #moreToggle.active { outline:2px solid var(--accent); }
  #morePanel .badge { background:#0e1a2a; border-color:#1d2b3f; color:#bcd1ef; }

  .featured{margin-top:16px;background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
  .fp-box{position:relative;width:100%;aspect-ratio:16/9;border-bottom:1px solid var(--ring);background:#000}
  .fp-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px}
  .fp-title{font-weight:800}
  .fp-caption{font-size:13px;color:var(--muted)}
  .fp-controls{display:flex;gap:8px;flex-wrap:wrap}

  .grid{display:grid;gap:10px;margin-top:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(min-width:860px){.grid{grid-template-columns:repeat(5,minmax(0,1fr))}}
  .slot{background:var(--card);border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:8px}
  .thumb{position:relative;aspect-ratio:16/9;border:1px solid var(--ring);border-radius:8px;overflow:hidden;background:#0a0a0a}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;filter:brightness(.9) contrast(1.1)}
  .slot .title{font-size:12px;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .slot .snip{font-size:11px;color:var(--muted); margin-top:2px}

  .notice{margin-top:14px;font-size:13px;color:#b7c6dc;background:#0f1b2a;border:1px dashed #223047;border-radius:12px;padding:10px 12px}
  footer{margin:28px 0 0;color:var(--muted);font-size:13px}

  #primer{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: radial-gradient(120% 120% at 50% 20%, rgba(24,39,61,.65), rgba(9,16,28,.85) 60%);
    backdrop-filter: blur(4px); z-index:999}
  #primerBtn{font-size:18px; padding:16px 22px; border-radius:16px; border:1px solid #203247; color:var(--ink);
    background: linear-gradient(180deg,#122033,#0f1b2a) padding-box, conic-gradient(from 0deg,#3bb5ff,#b9ffe6,#7fd0ff,#3bb5ff) border-box}

  .toast{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    background:#101b2a; border:1px solid var(--ring); border-radius:12px; color:var(--ink);
    box-shadow:0 10px 30px rgba(0,0,0,.35); padding:10px 12px; font-size:14px; display:flex; gap:12px; align-items:center; z-index:998
  }
  .hide{display:none}
</style>
</head>
<body class="mode-redblue"><!-- default Red↔Blue ON -->
<canvas id="stars" aria-hidden="true"></canvas>

<!-- One-tap activate -->
<div id="primer" role="dialog" aria-modal="true" aria-label="Start session">
  <button id="primerBtn" class="btn primary">
    ▶ Activate Bluefire
    <span class="small" style="display:block;opacity:.8;margin-top:4px">Dark iPhone bars • Enables tones • Preloads first video</span>
  </button>
</div>

<div class="wrap">
  <header>
    <a class="brand" href="#">
      <div class="jelly" aria-hidden="true"></div>
      <div>
        <h1>Clarity · Shared Edge Sync</h1>
        <div class="small">Mutual Seed Bursts on Sigrid — Red↔Blue only · Loop → Calm</div>
      </div>
    </a>
    <span class="tag">consent • clarity • kindness</span>
  </header>

  <!-- GATES -->
  <section class="bar" aria-label="Gates">
    <div class="switch" role="tablist" aria-label="Color Mode">
      <button id="modeNatural" aria-selected="false">Natural</button>
      <button id="modeRB" class="active" aria-selected="true">Red↔Blue</button>
      <button id="modeOpp" aria-selected="false">Opposite</button>
    </div>

    <div class="switch" role="tablist" aria-label="Playlist set" style="margin-left:6px">
      <button id="setTracks" class="active" aria-selected="true">Sigrid — Tracks</button>
      <button id="setInterviews" aria-selected="false">Interviews</button>
    </div>

    <span class="pill"><strong>Intensity</strong>
      <input id="intensity" type="range" min="1" max="5" value="4" style="vertical-align:middle">
      <span id="intensityLbl" class="badge">4 · deep</span>
    </span>

    <span class="pill"><strong>Cadence</strong>
      <select id="cadence">
        <option value="sync">Auto (burst length + rest)</option>
        <option value="short">Fast (~4s)</option>
        <option value="medium" selected>Steady (~8s)</option>
        <option value="long">Spacious (~14s)</option>
      </select>
    </span>

    <span class="pill">Tones
      <label style="margin-left:8px"><input type="checkbox" id="tone128" checked>128</label>
      <label><input type="checkbox" id="tone256" checked>256</label>
      <label>Level <input id="toneLevel" type="range" min="0" max="100" value="68" style="vertical-align:middle"></label>
      <button id="toneToggle" class="btn" style="padding:6px 10px">On</button>
    </span>

    <span class="pill">Status: <span id="status" class="badge">waiting</span></span>
    <!-- More (advanced) -->
    <button id="moreToggle" class="btn" style="padding:10px 12px">More ▸</button>
  </section>

  <!-- SYNC / BURSTS -->
  <section class="bar" aria-label="Shared Edge Sync">
    <button id="syncEdge" class="btn" title="Arm burst at next :00 or :30">Sync at :00/:30</button>
    <button id="shareSync" class="btn" title="Copy a shared-edge link">Share Sync</button>
    <button id="burstOnce" class="btn" title="One Seed Burst (RB + Tracks)">One Seed Burst</button>
    <button id="startLoop" class="btn" title="Loop bursts until Calm">Start Seed Loop</button>
    <button id="calmNow" class="btn" title="Stop/settle into Calm">Calm Now</button>
    <span class="pill">Loop: <span id="loopState" class="badge">idle</span></span>
  </section>

  <!-- More panel (advanced) -->
  <section id="morePanel" class="bar" aria-label="Advanced controls" style="display:none">
    <span class="pill"><strong>Intensity</strong>
      <input id="intensity_adv" type="range" min="1" max="5" value="4" style="vertical-align:middle">
      <span id="intensityLbl_adv" class="badge">4 · deep</span>
    </span>

    <span class="pill"><strong>Shaping</strong>
      <label style="margin-left:8px">Up-ramp ms <input id="seedUp" type="number" value="350" min="120" max="1200" step="10" style="width:80px"></label>
      <label>Release ms <input id="seedRel" type="number" value="350" min="120" max="1200" step="10" style="width:80px"></label>
      <label>Alias Hz <input id="aliasHz" type="number" value="102" min="85" max="140" step="1" style="width:70px"></label>
    </span>

    <span class="pill"><strong>Width</strong>
      <label style="margin-left:8px">Cap (0.25–0.70) <input id="widthCap" type="number" value="0.55" min="0.25" max="0.70" step="0.01" style="width:85px"></label>
    </span>

    <span class="pill">
      <strong>Cadence</strong>
      <select id="cadence_adv">
        <option value="short">Fast (~4s rest)</option>
        <option value="medium" selected>Steady (~8s rest)</option>
        <option value="long">Spacious (~14s rest)</option>
        <option value="sync">Auto (burst length + rest)</option>
      </select>
    </span>

    <span class="pill" title="Ethics & intent">
      <strong>Intent</strong>
      <span class="badge">Not sex — a care tool</span>
    </span>
  </section>

  <section class="notice">
    **How it works:** **Activate** → pick **Red↔Blue** + **Sigrid — Tracks** → optional **Sync at :00/:30**.  
    Bursts loop (burst → rest) until **Calm Now**. Interviews never burst. Anyone can run it — for Sigrid, for Marina, or for themselves.
  </section>

  <!-- PLAYER -->
  <section class="featured" aria-live="polite">
    <div class="fp-box"><div id="fp"></div></div>
    <div class="fp-meta">
      <div>
        <div id="fpTitle" class="fp-title">—</div>
        <div id="fpCaption" class="fp-caption"></div>
      </div>
      <div class="fp-controls">
        <button class="btn" id="fpPlay">Play</button>
        <button class="btn" id="fpPause">Pause</button>
        <button class="btn" id="fpPrev">⟵ Prev</button>
        <button class="btn" id="fpNext">Next ⟶</button>
        <button class="btn" id="fpPiP">PiP</button>
      </div>
    </div>
  </section>

  <!-- TRACKS -->
  <section id="grid" class="grid" aria-label="Sigrid tracks"></section>

  <footer>
    <div class="notice">
      Start low. Intensity scales feel (depth/width/duration) — not raw loudness.  
      Off-ramps always visible. Bursts are **music-only** and **RB-only** by design.
    </div>
    <p class="small">Local only. Media © respective owners.</p>
  </footer>
</div>

<!-- Toast -->
<div id="toast" class="toast hide">
  <span id="toastMsg">—</span>
  <button id="toastClose" class="btn" style="padding:6px 10px">OK</button>
</div>

<div id="prewarmBin" aria-hidden="true" style="position:absolute;left:-9999px;top:auto;width:0;height:0;overflow:hidden"></div>

<script id="yt-iframe-api" src="https://www.youtube.com/iframe_api"></script>
<script>
/* ===== Core State ===== */
const state = {
  color:'redblue', set:'tracks', ctx:null, tonesOn:true, device:'default',
  audio:{}, fp:null, fpIndex:0, loop:{active:false, timer:null}, intensity:4,
  cadence:'medium', burstNode:null, widthNode:null, pendingSync:null
};

/* ===== Tracks / Interviews (Sigrid) ===== */
const TRACKS = [
  {id:'cIriwVhRPVA', title:'Strangers'},
  {id:'w5x93pXSmRM', title:'Don’t Feel Like Crying'},
  {id:'1uHt2LrCSWg', title:'Sucker Punch'},
  {id:'E7lr7pU9fYA', title:'Mirror'},
  {id:'xzonQoON9eo', title:'Don’t Kill My Vibe'},
  {id:'z6A2LHGx8_A', title:'High Five'},
  {id:'udRAIF6MOm8', title:'Burning Bridges'},
  {id:'4j7LGMc9ZGU', title:'It Gets Dark'},
  {id:'hKvbaZTAQN0', title:'Dynamite (Acoustic)'},
  {id:'bNuCNZK-r5A', title:'Plot Twist'}
];
const INTERVIEWS = [
  {id:'oEC6zOhHydI', title:'Strangers — Glasto 2019 (Live)'},
  {id:'wk1NDhE_A1o', title:'Dynamite — Øya 2023'},
  {id:'cn7kW-6ZNYQ', title:'Sucker Punch — Øya 2019'},
  {id:'M4Sbee9Mj2o', title:'Strangers — BBC Live Lounge'},
  {id:'zgB5unpoEaY', title:'Strangers — Nobel 2017'},
  {id:'9rLgag0tCAU', title:'BBC Sound of 2018 — Profile'},
  {id:'O-ozpz4JD8o', title:'Abbie McCarthy — Interview'},
  {id:'XkAyr6u2Mp0', title:'How To Let Go — Interview'},
  {id:'shDlDZQoAaY', title:'Making “It Gets Dark” — BTS'},
  {id:'CeZklpxa51A', title:'Pop Around — Full Interview'}
];

/* ===== DOM ===== */
const statusEl = document.getElementById('status');
const loopState = document.getElementById('loopState');
const modeNatural = document.getElementById('modeNatural');
const modeRB = document.getElementById('modeRB');
const modeOpp = document.getElementById('modeOpp');
const setTracksBtn = document.getElementById('setTracks');
const setInterBtn = document.getElementById('setInterviews');
const intensityEl = document.getElementById('intensity');
const intensityLbl = document.getElementById('intensityLbl');
const cadenceEl = document.getElementById('cadence');
const tone128 = document.getElementById('tone128');
const tone256 = document.getElementById('tone256');
const toneToggle = document.getElementById('toneToggle');
const toneLevel = document.getElementById('toneLevel');
const startLoop = document.getElementById('startLoop');
const burstOnce = document.getElementById('burstOnce');
const calmNow = document.getElementById('calmNow');
const syncEdge = document.getElementById('syncEdge');
const shareSync = document.getElementById('shareSync');
const toast = document.getElementById('toast');
const toastMsg = document.getElementById('toastMsg');
const toastClose = document.getElementById('toastClose');
const primer = document.getElementById('primer');
const primerBtn = document.getElementById('primerBtn');
const grid = document.getElementById('grid');
const fpTitle = document.getElementById('fpTitle');
const fpCaption = document.getElementById('fpCaption');

/* ===== Helpers ===== */
function tag(txt, mode){
  statusEl.textContent = txt;
  const map = {ok:['#102a21','#174a3a','#b9ffe6'], wait:['#0f1b2a','#223047','#b7c6dc'], warn:['#2a210f','#4a3a17','#ffd596']};
  const [bg,bd,fg]=map[mode||'ok']; statusEl.style.background=bg; statusEl.style.borderColor=bd; statusEl.style.color=fg;
}
function toastShow(msg){ toastMsg.textContent = msg; toast.classList.remove('hide'); }
toastClose.onclick = ()=> toast.classList.add('hide');
function gateOK(){ return state.color==='redblue' && state.set==='tracks'; }
function updateButtons(){
  const ok = gateOK();
  startLoop.disabled = !ok; burstOnce.disabled = !ok; syncEdge.disabled = !ok; shareSync.disabled = !ok;
}

/* ===== YouTube ===== */
let YT_READY=false;
window.onYouTubeIframeAPIReady = ()=>{ YT_READY=true; buildUI(); prewarmAll(); };

function listBySet(){ return state.set==='tracks'?TRACKS:INTERVIEWS; }
function buildUI(){ buildFeatured(); buildSlots(); updateButtons(); }
function buildFeatured(){
  if(!YT_READY) return;
  const L=listBySet(), item=L[state.fpIndex]||L[0];
  fpTitle.textContent = item? (item.title||'') : '—';
  if(state.fp){ try{ state.fp.destroy(); }catch{} }
  state.fp = new YT.Player('fp', {
    height:'100%', width:'100%', videoId:item?item.id:'',
    playerVars:{autoplay:0, controls:1, modestbranding:1, rel:0, playsinline:1, iv_load_policy:3}
  });
}
function buildSlots(){
  grid.innerHTML='';
  const L = listBySet();
  for(let i=0;i<Math.max(10, L.length); i++){
    const it = L[i];
    const slot = document.createElement('article'); slot.className='slot';
    const thumb = document.createElement('div'); thumb.className='thumb';
    const img = document.createElement('img'); img.alt = it? it.title : 'empty';
    if(it){ img.src=`https://i.ytimg.com/vi/${it.id}/hqdefault.jpg`; img.loading='lazy'; }
    const title = document.createElement('div'); title.className='title'; title.textContent = it? it.title : 'empty';
    const snip = document.createElement('div'); snip.className='snip'; snip.textContent='';
    thumb.appendChild(img); slot.append(thumb, title, snip); grid.appendChild(slot);
    if(it){ thumb.onclick = ()=>{ state.fpIndex=i; buildFeatured(); try{ state.fp.playVideo(); }catch{} }; }
  }
}
function prewarmAll(){
  if(!YT_READY) return;
  const L = listBySet(); const bin=document.getElementById('prewarmBin'); bin.innerHTML='';
  L.forEach((v,i)=>{ const d=document.createElement('div'); d.id='warm_'+i; bin.appendChild(d);
    new YT.Player(d.id,{height:'0',width:'0',videoId:v.id,playerVars:{autoplay:0,controls:0,rel:0,playsinline:1,iv_load_policy:3,mute:1}});
  });
}

/* ===== Tone Engine ===== */
(function detect(){ const ua=navigator.userAgent||''; if(/iPhone/.test(ua)) state.device='iphone'; else if(/Android/.test(ua)) state.device='mobile'; })();

function initTones(){
  if(state.ctx) return;
  const AC = window.AudioContext||window.webkitAudioContext; state.ctx = new AC();
  const ctx=state.ctx;

  const main=ctx.createGain(), merger=ctx.createChannelMerger(2), mono=ctx.createGain(), wide=ctx.createGain(), comp=ctx.createDynamicsCompressor();
  wide.gain.value=1; mono.gain.value=(state.device==='iphone'||state.device==='mobile')?0.25:0.12;
  merger.connect(wide).connect(main); mono.connect(main);
  comp.threshold.value=-24; comp.knee.value=12; comp.ratio.value=2; comp.attack.value=.02; comp.release.value=.25;
  // true-peak soft guard
  const shaper = ctx.createWaveShaper(); const curve = new Float32Array(44100);
  for (let i=0;i<curve.length;i++){ const x = (i/22050)-1; curve[i] = Math.tanh(1.2*x); }
  shaper.curve = curve; shaper.oversample = '4x';
  const post = ctx.createGain(); post.gain.value = 0.98;
  main.connect(shaper).connect(post).connect(comp).connect(ctx.destination);

  const delta=(state.device==='iphone'||state.device==='mobile')?0.7:1.2;
  function pair(freq, base){
    const l=ctx.createOscillator(), r=ctx.createOscillator(); l.type=r.type='sine'; l.frequency.value=freq-delta/2; r.frequency.value=freq+delta/2;
    const gL=ctx.createGain(), gR=ctx.createGain(); gL.gain.value=gR.gain.value=base;
    const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=(freq===128)?0.08:0.12;
    const lfoL=ctx.createGain(), lfoR=ctx.createGain(); lfoL.gain.value=(freq===128)?0.12:0.08; lfoR.gain.value=lfoL.gain.value;
    lfo.connect(lfoL).connect(gL.gain); lfo.connect(lfoR).connect(gR.gain); lfo.start();
    l.connect(gL); r.connect(gR); gL.connect(merger,0,0); gR.connect(merger,0,1);
    const mL=ctx.createGain(), mR=ctx.createGain(); mL.gain.value=mR.gain.value=base*0.5; l.connect(mL).connect(mono); r.connect(mR).connect(mono);
    l.start(); r.start(); return {gL,gR};
  }

  state.audio = {ctx, main, merger, mono, wide, comp,
    t128: pair(128,.17), t256: pair(256,.13),
    air: (()=>{ const n=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate), d=n.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*.02;
      const src=ctx.createBufferSource(); src.buffer=n; src.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1500; const g=ctx.createGain(); g.gain.value=.022;
      src.connect(hp).connect(g).connect(main); src.start(); return {g}; })()
  };
  applyIntensity(); routeTones();
}

function applyIntensity(){
  const i = Number(intensityEl.value||4); state.intensity=i;
  state._g128 = {1:.12,2:.14,3:.16,4:.17,5:.18}[i];
  state._g256 = {1:.10,2:.11,3:.12,4:.13,5:.14}[i];
  state._gAir = {1:.014,2:.018,3:.021,4:.023,5:.026}[i];
  intensityLbl.textContent = i + (i<=2?' · gentle': i===3?' · steady': i===4?' · deep':' · unbelievable');
  routeTones();
}
function routeTones(){
  if(!state.audio) return; const lvl=Number(toneLevel.value)/100, on=state.tonesOn;
  state.audio.t128.gL.gain.value = state.audio.t128.gR.gain.value = (on && tone128.checked)? state._g128*lvl : 0;
  state.audio.t256.gL.gain.value = state.audio.t256.gR.gain.value = (on && tone256.checked)? state._g256*lvl : 0;
  state.audio.air.g.gain.value = on ? state._gAir*lvl : 0;
  tag(on?'tones on':'silent', on?'ok':'wait');
}

/* ===== Exposed constants for advanced panel ===== */
let SEED_UP_MS = 350;   // opening ramp (ms)
let SEED_REL_MS = 350;  // release ramp (ms)
let ALIAS_HZ    = 102;  // tiny-speaker alias (Hz)
let WIDTH_CAP   = 0.55; // width cap on tiny devices (0.25–0.70)

/* ===== Seed Burst — Stable v10.1 (music-only, RB-only) ===== */
function claritySeedBurst(){
  if(!(state && state.color==='redblue' && state.set==='tracks')) return 0;
  if(!state.ctx || !state.audio || !state.audio.main) return 0;
  const ctx = state.ctx;
  if (ctx.state !== 'running') { try{ ctx.resume(); }catch{} }

  if(state.burstNode && state.burstNode.stop){ try{ state.burstNode.stop(); }catch{} state.burstNode=null; }

  const lvl = Number(toneLevel?.value || 68)/100;
  const intensity = Number(state.intensity || 4);

  const durMap   = {1:18,2:24,3:32,4:38,5:45};
  const depthMap = {1:.18,2:.22,3:.26,4:.30,5:.34};
  const tremMap  = {1:.08,2:.10,3:.12,4:.14,5:.16};
  const widthMap = {1:.25,2:.35,3:.45,4:.55,5:.65};

  const D  = durMap[intensity]   ?? 32;
  const DP = depthMap[intensity] ?? .26;
  const TM = tremMap[intensity]  ?? .12;
  const W  = widthMap[intensity] ?? .45;

  const bus   = ctx.createGain(); bus.gain.value = 0.0;
  const red   = ctx.createGain(); red.gain.value = 0.0;
  const blue  = ctx.createGain(); blue.gain.value = 0.0;
  const merge = ctx.createChannelMerger(2);
  red.connect(merge,0,0); blue.connect(merge,0,1);

  const width = ctx.createGain(); width.gain.value = 1.0; state.widthNode = width;

  const limiter = ctx.createDynamicsCompressor();
  limiter.threshold.value=-10; limiter.knee.value=12; limiter.ratio.value=6; limiter.attack.value=0.005; limiter.release.value=0.2;
  const out = ctx.createGain(); out.gain.value = 0.19 * lvl;

  merge.connect(width).connect(bus).connect(limiter).connect(out).connect(state.audio.main);

  const throb = ctx.createOscillator(); throb.type='sine'; throb.frequency.value = 0.9;
  const thR=ctx.createGain(), thB=ctx.createGain();
  thR.gain.value = DP * lvl; thB.gain.value = DP * lvl;
  throb.connect(thR).connect(red.gain);
  throb.connect(thB).connect(blue.gain);
  throb.start();

  const trem = ctx.createOscillator(); trem.type='sine'; trem.frequency.value = 5.5;
  const trR=ctx.createGain(), trB=ctx.createGain();
  trR.gain.value = TM * lvl * 0.6; trB.gain.value = TM * lvl * 0.6;
  trem.connect(trR).connect(red.gain);
  trem.connect(trB).connect(blue.gain);
  trem.start();

  function tone(f, gL, gR){
    const oL = ctx.createOscillator(); oL.type='sine'; oL.frequency.value=f;
    const oR = ctx.createOscillator(); oR.type='sine'; oR.frequency.value=f;
    const g1 = ctx.createGain(), g2 = ctx.createGain();
    const t0 = ctx.currentTime + 0.002;
    g1.gain.setValueAtTime(0, t0); g2.gain.setValueAtTime(0, t0);
    g1.gain.linearRampToValueAtTime(gL, t0 + SEED_UP_MS/1000);
    g2.gain.linearRampToValueAtTime(gR, t0 + SEED_UP_MS/1000);
    oL.connect(g1).connect(red); oR.connect(g2).connect(blue);
    oL.start(); oR.start();
    return ()=>{ try{
      const t1 = ctx.currentTime;
      g1.gain.setTargetAtTime(0, t1, SEED_REL_MS/1000);
      g2.gain.setTargetAtTime(0, t1, SEED_REL_MS/1000);
      setTimeout(()=>{ try{oL.stop();oR.stop();}catch{} }, 30);
    }catch{} };
  }

  const stops = [];
  stops.push(tone(64,  0.12*lvl, 0.08*lvl));
  stops.push(tone(128, 0.13*lvl, 0.13*lvl));
  stops.push(tone(256, 0.09*lvl, 0.10*lvl));
  const tiny = (state.device==='iphone' || state.device==='mobile');
  if(tiny) stops.push(tone(ALIAS_HZ, 0.06*lvl, 0.06*lvl));

  const t0 = ctx.currentTime + 0.02;
  bus.gain.setValueAtTime(0.0, t0);
  bus.gain.linearRampToValueAtTime(1.0, t0 + SEED_UP_MS/1000);
  const tHold = t0 + D - (SEED_REL_MS/1000 + 0.45);
  bus.gain.setTargetAtTime(0.0, tHold, SEED_REL_MS/1000);

  const Wcap = tiny ? Math.min(1.0 + WIDTH_CAP, 1.7) : 1.0 + W;
  width.gain.setValueAtTime(1.0, t0);
  width.gain.linearRampToValueAtTime(Wcap, t0 + 0.8);
  width.gain.setTargetAtTime(1.05, tHold, SEED_REL_MS/1000);

  const stopAll = ()=>{
    try{ throb.stop(); trem.stop(); }catch{}
    stops.forEach(fn=>{ try{ fn(); }catch{} });
    [merge,width,bus,limiter,out,red,blue].forEach(n=>{ try{ n.disconnect(); }catch{} });
    state.burstNode = null;
  };
  setTimeout(stopAll, D*1000 + 500);
  state.burstNode = { stop: stopAll, dur: D };
  return D;
}

/* ===== Loop Manager ===== */
function cadenceRest(d){
  const m = cadenceEl.value;
  if(m==='short') return 4;
  if(m==='medium') return 8;
  if(m==='long') return 14;
  return Math.max(6, 8);
}
function loopTick(){
  if(!state.loop.active) return;
  if(state.burstNode){ try{ state.burstNode.stop(); }catch{} state.burstNode=null; }
  const dur = claritySeedBurst();
  if(!dur){ stopSeedLoop(); return; }
  loopState.textContent = 'bursting';
  const rest = cadenceRest(dur);
  state.loop.timer = setTimeout(()=>{
    if(!state.loop.active) return;
    loopState.textContent = 'resting';
    state.loop.timer = setTimeout(()=>{ if(state.loop.active) loopTick(); }, rest*1000);
  }, dur*1000 + 250);
}
function startSeedLoop(){
  if(!gateOK()){ toastShow('Enable Red↔Blue and choose Tracks.'); return; }
  if(!state.ctx){ toastShow('Tap Activate first.'); return; }
  stopSeedLoop();
  state.loop.active = true; loopState.textContent = 'starting';
  loopTick();
}
function stopSeedLoop(){
  state.loop.active = false;
  if(state.loop.timer){ clearTimeout(state.loop.timer); state.loop.timer=null; }
  try{ state.burstNode?.stop?.(); }catch{}
  loopState.textContent = 'idle';
}

/* ===== Calm Phase ===== */
function enterCalm(){
  stopSeedLoop();
  if(!state.audio || !state.ctx) return;
  const ctx=state.ctx, lvl=Number(toneLevel.value)/100||.68;
  const t=ctx.currentTime;
  state.audio.t128.gL.gain.setTargetAtTime(state._g128*lvl*0.6, t,.06);
  state.audio.t128.gR.gain.setTargetAtTime(state._g128*lvl*0.6, t,.06);
  state.audio.t256.gL.gain.setTargetAtTime(state._g256*lvl*0.45, t,.06);
  state.audio.t256.gR.gain.setTargetAtTime(state._g256*lvl*0.45, t,.06);
  state.audio.air.g.gain.setTargetAtTime(state._gAir*lvl*0.6, t,.06);
  loopState.textContent='calm';
  setTimeout(()=>{
    const t2=ctx.currentTime;
    state.audio.t128.gL.gain.setTargetAtTime(0, t2,.4);
    state.audio.t128.gR.gain.setTargetAtTime(0, t2,.4);
    state.audio.t256.gL.gain.setTargetAtTime(0, t2,.4);
    state.audio.t256.gR.gain.setTargetAtTime(0, t2,.4);
    state.audio.air.g.gain.setTargetAtTime(0, t2,.4);
    loopState.textContent='idle';
  }, 120000);
}

/* ===== Shared Edge Sync ===== */
function msToNextEdge30(now=Date.now()){
  const s = new Date(now); const sec = s.getUTCSeconds(); const ms = s.getUTCMilliseconds();
  return (sec<30 ? (30-sec)*1000 - ms : (60-sec)*1000 - ms);
}
let syncTimer = null;
function scheduleEdge(){
  if(!gateOK()){ toastShow('Enable Red↔Blue and choose Tracks.'); return; }
  if(!state.ctx){ toastShow('Tap Activate first.'); return; }
  if(syncTimer){ clearTimeout(syncTimer); syncTimer=null; }
  const delay = msToNextEdge30();
  const secs = Math.max(0, Math.round(delay/1000));
  toastShow('Synced: starting burst at next edge in ~'+secs+'s');
  syncTimer = setTimeout(()=>{ claritySeedBurst(); }, delay);
}
function buildShareURLEdge(){
  const url = new URL(location.href.split('#')[0]);
  url.searchParams.set('sync','edge');
  url.searchParams.set('mode','rb');
  url.searchParams.set('set','tracks');
  url.searchParams.set('int', String(state.intensity||4));
  return url.toString();
}
function parseSyncFromURL(){
  const q = new URLSearchParams(location.search);
  const s = q.get('sync'); const m = q.get('mode'); const st = q.get('set'); const it = Number(q.get('int')||4);
  if(m==='rb'){ document.body.classList.remove('mode-natural','mode-opposite'); document.body.classList.add('mode-redblue'); state.color='redblue'; }
  state.set = (st==='interviews')?'interviews':'tracks';
  if(it>=1 && it<=5){ intensityEl.value = String(it); applyIntensity(); }
  if(s==='edge'){ state.pendingSync = 'edge'; }
}

/* ===== Stars ===== */
(function stars(){
  const c=document.getElementById('stars'); const dpr=Math.max(1,window.devicePixelRatio||1);
  const x=c.getContext('2d'); let flakes=[], mouseY=0, scrollY=0;
  function size(){ c.width=innerWidth*dpr; c.height=innerHeight*dpr; x.setTransform(dpr,0,0,dpr,0,0); }
  function seed(N=120){ flakes=new Array(N).fill(0).map(()=>({x:Math.random()*innerWidth,y:-10-Math.random()*innerHeight,r:0.6+Math.random()*1.8,s:.35+Math.random()*1,o:.35+Math.random()*.45,l:.2+Math.random()*.8})); }
  function draw(){
    x.clearRect(0,0,innerWidth,innerHeight);
    const par=(scrollY*0.12+(mouseY-innerHeight/2)*0.02);
    for(const f of flakes){ f.y+=f.s+par*0.0015; f.x+=Math.sin((f.y+par)*.01)*f.l; if(f.y>innerHeight+10){ f.y=-10; f.x=Math.random()*innerWidth; }
      x.globalAlpha=f.o; x.beginPath(); x.arc(f.x,f.y,f.r,0,Math.PI*2); x.fillStyle="rgba(127,208,255,.55)"; x.fill(); }
    requestAnimationFrame(draw);
  }
  window.addEventListener('resize', ()=>{ size(); seed(flakes.length); });
  window.addEventListener('mousemove', e=>{ mouseY=e.clientY; });
  window.addEventListener('scroll', ()=>{ scrollY=window.scrollY||0; });
  size(); seed(); draw();
})();

/* ===== Wire Controls ===== */
document.getElementById('fpPlay').onclick=()=>{ try{ state.fp.playVideo(); }catch{} };
document.getElementById('fpPause').onclick=()=>{ try{ state.fp.pauseVideo(); }catch{} };
document.getElementById('fpNext').onclick=()=>{ const L=listBySet(); let i=state.fpIndex+1; if(i>=Math.max(10,L.length)) i=0; state.fpIndex=i; buildFeatured(); try{ state.fp.playVideo(); }catch{} };
document.getElementById('fpPrev').onclick=()=>{ const L=listBySet(); let i=state.fpIndex-1; if(i<0) i=Math.max(10,L.length)-1; state.fpIndex=i; buildFeatured(); try{ state.fp.playVideo(); }catch{} };
document.getElementById('fpPiP').onclick=async()=>{ const v=document.querySelector('video'); if(v && v.requestPictureInPicture){ try{ await v.requestPictureInPicture(); }catch{} } };

modeNatural.onclick=()=>{ document.body.classList.remove('mode-redblue','mode-opposite'); document.body.classList.add('mode-natural'); state.color='natural'; updateButtons(); };
modeRB.onclick=()=>{ document.body.classList.remove('mode-natural','mode-opposite'); document.body.classList.add('mode-redblue'); state.color='redblue'; updateButtons(); };
modeOpp.onclick=()=>{ document.body.classList.remove('mode-redblue','mode-natural'); document.body.classList.add('mode-opposite'); state.color='opposite'; updateButtons(); };

setTracksBtn.onclick=()=>{ state.set='tracks'; state.fpIndex=0; buildUI(); prewarmAll(); updateButtons(); };
setInterBtn.onclick=()=>{ state.set='interviews'; state.fpIndex=0; buildUI(); prewarmAll(); updateButtons(); };

intensityEl.oninput = ()=> applyIntensity();
cadenceEl.onchange = ()=>{ state.cadence = cadenceEl.value; };

toneToggle.onclick = async ()=>{ if(!state.ctx){ initTones(); try{ await state.ctx.resume(); }catch{} } state.tonesOn=!state.tonesOn; routeTones(); };
tone128.onchange = routeTones; tone256.onchange = routeTones; toneLevel.oninput = routeTones;

startLoop.onclick = ()=>{ if(!gateOK()){ toastShow('Enable Red↔Blue and choose Tracks.'); return; } startSeedLoop(); };
burstOnce.onclick = ()=>{ if(!gateOK()){ toastShow('Enable Red↔Blue and choose Tracks.'); return; } claritySeedBurst(); };
calmNow.onclick = ()=> enterCalm();

syncEdge.onclick = ()=> scheduleEdge();
shareSync.onclick = ()=>{
  if(!gateOK()){ toastShow('Enable Red↔Blue and choose Tracks.'); return; }
  const link = buildShareURLEdge();
  if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(link); }
  toastShow('Copied a shared-edge link. Tell them: tap Activate, then it will arm for the next :00/:30.');
};

primerBtn.onclick = async ()=>{
  initTones(); try{ await state.ctx.resume(); }catch{}
  tag('tones on','ok'); primer.style.display='none';
  if(!state.fp) buildFeatured();
  try{ state.fp.playVideo(); }catch{}
  if(state.pendingSync==='edge'){ scheduleEdge(); }
};

/* ===== More Panel (advanced) ===== */
const moreToggle  = document.getElementById('moreToggle');
const morePanel   = document.getElementById('morePanel');
const intensityAdv= document.getElementById('intensity_adv');
const intensityLblAdv = document.getElementById('intensityLbl_adv');
const seedUp  = document.getElementById('seedUp');
const seedRel = document.getElementById('seedRel');
const aliasHz = document.getElementById('aliasHz');
const widthCap= document.getElementById('widthCap');
const cadenceAdv = document.getElementById('cadence_adv');

if(moreToggle){
  moreToggle.addEventListener('click', ()=>{
    const open = morePanel.style.display !== 'none';
    morePanel.style.display = open ? 'none' : 'flex';
    moreToggle.classList.toggle('active', !open);
    moreToggle.textContent = open ? 'More ▸' : 'More ▾';
  });
}

(function syncIntensity(){
  const main = document.getElementById('intensity');
  const updateLbl = (val)=>{
    const tag = (val<=2?' · gentle': val==3?' · steady': val==4?' · deep':' · unbelievable');
    intensityLblAdv.textContent = val + tag;
    intensityLbl.textContent = val + tag;
  };
  if(main && intensityAdv){
    intensityAdv.value = main.value;
    updateLbl(Number(intensityAdv.value));
    main.addEventListener('input', ()=>{ intensityAdv.value = main.value; updateLbl(Number(main.value)); applyIntensity(); });
    intensityAdv.addEventListener('input', ()=>{
      main.value = intensityAdv.value; updateLbl(Number(intensityAdv.value)); applyIntensity();
    });
  }
})();

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
seedUp?.addEventListener('change', ()=>{ SEED_UP_MS  = clamp(Number(seedUp.value||350), 120, 1200); });
seedRel?.addEventListener('change',()=>{ SEED_REL_MS = clamp(Number(seedRel.value||350),120, 1200); });
aliasHz?.addEventListener('change',()=>{ ALIAS_HZ    = clamp(Number(aliasHz.value||102),85, 140); });
widthCap?.addEventListener('change',()=>{ WIDTH_CAP  = clamp(Number(widthCap.value||0.55),0.25,0.70); });

cadenceAdv?.addEventListener('change', ()=>{
  cadenceEl.value = cadenceAdv.value;
  state.cadence = cadenceAdv.value;
});

/* ===== Re-arm AudioContext when returning to tab (iOS) ===== */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible' && state?.ctx?.state!=='running'){
    try{ state.ctx.resume(); }catch{}
  }
});

/* ===== Boot ===== */
function updateButtons(){ const ok = gateOK(); startLoop.disabled=!ok; burstOnce.disabled=!ok; syncEdge.disabled=!ok; shareSync.disabled=!ok; }
(function init(){
  buildUI();
  // parse ?sync=edge&mode=rb&set=tracks&int=4
  parseSyncFromURL();
})();
</script>
</body>
</html>
