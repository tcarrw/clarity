<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clarity · Sigrid Field — clarity.plnt.earth</title>
<meta name="description" content="Ritual Mode with intensity control, hidden Red/Blue music burst, 128/256 Hz tones, and Norwegian Whisper micro-lessons." />
<meta name="theme-color" content="#0b0d11">
<meta name="color-scheme" content="dark">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link rel="dns-prefetch" href="https://www.youtube.com">
<link rel="dns-prefetch" href="https://i.ytimg.com">
<link rel="dns-prefetch" href="https://www.google.com">
<link rel="preconnect" href="https://www.youtube.com" crossorigin>
<link rel="preconnect" href="https://i.ytimg.com" crossorigin>
<link rel="preconnect" href="https://www.google.com" crossorigin>

<style>
  :root{
    --bg:#0b0d11; --ink:#e9ecf4; --muted:#9aa6b6; --card:#101425; --ring:#1b2433;
    --accent:#7fd0ff; --accent-2:#b9ffe6; --shadow:0 14px 40px rgba(3,8,14,.55);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
    color:var(--ink);
    background:
      radial-gradient(120% 120% at 20% -10%, rgba(127,208,255,.12), transparent 50%),
      radial-gradient(100% 100% at 120% 0%, rgba(185,255,230,.08), transparent 60%),
      linear-gradient(180deg,#0b0d11 0%, #0b1018 60%, #0b0d11 100%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow-x:hidden;
  }
  #stars{position:fixed; inset:0; z-index:-1; filter:drop-shadow(0 0 2px rgba(127,208,255,.25))}
  .wrap{max-width:1080px;margin:0 auto;padding:20px 14px 80px; position:relative; z-index:1}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 16px}
  .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
  .jelly{width:42px;height:42px;border-radius:14px;
    background:radial-gradient(120% 120% at 20% 10%, #11304a 0%, #0e2133 50%, #0c1624 80%) padding-box,
               conic-gradient(from 0deg at 50% 60%, #0f2236, #173a59, #123047, #0f2236) border-box;
    border:2px solid transparent; box-shadow:var(--shadow),0 0 40px rgba(127,208,255,.25) inset; position:relative; overflow:hidden}
  .jelly:after{content:"";position:absolute;left:50%;top:55%;width:70%;height:70%;transform:translate(-50%,-50%);
    filter:blur(12px); background:radial-gradient(50% 60% at 50% 40%, rgba(127,208,255,.18), transparent 70%)}
  h1{font-size:20px;margin:0}
  .small{font-size:12px;color:var(--muted)}
  .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f1827;border:1px solid var(--ring);color:#b7c6dc}

  .tonebar{
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:var(--card);border:1px solid var(--ring);
    border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)
  }
  .btn{appearance:none;border:1px solid var(--ring);background:linear-gradient(180deg,#122034,#0f1b2b);color:var(--ink);
    padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer; box-shadow:var(--shadow); transition:transform .08s ease, box-shadow .2s, border-color .2s}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,#13263c,#0f1e30) padding-box, conic-gradient(from 0deg,#3bb5ff,#b9ffe6,#7fd0ff,#3bb5ff) border-box; border:1px solid transparent}
  .switch{display:inline-flex;border:1px solid var(--ring);border-radius:12px;overflow:hidden;background:#0f1b2a}
  .switch button{border:0;background:transparent;color:var(--ink);padding:8px 12px;cursor:pointer}
  .switch button.active{background:#142235;font-weight:700}
  .pill{font-size:12px;border:1px solid var(--ring);padding:4px 8px;border-radius:999px;background:#0f1b2a;color:var(--ink)}
  .pill .row{display:inline-flex;gap:8px;align-items:center}

  .featured{margin-top:16px;background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
  .fp-box{position:relative;width:100%;aspect-ratio:16/9;border-bottom:1px solid var(--ring);background:#000}
  .fp-meta{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px}
  .fp-title{font-weight:800}
  .fp-caption{font-size:13px;color:var(--muted)}
  .fp-controls{display:flex;gap:8px;flex-wrap:wrap}

  .grid{display:grid;gap:10px;margin-top:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(min-width:860px){.grid{grid-template-columns:repeat(5,minmax(0,1fr))}}
  .slot{background:var(--card);border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:8px}
  .thumb{position:relative;aspect-ratio:16/9;border:1px solid var(--ring);border-radius:8px;overflow:hidden;background:#0a0a0a}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block;filter:brightness(.9) contrast(1.1)}
  .slot .title{font-size:12px;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .slot .snip{font-size:11px;color:var(--muted); margin-top:2px}

  .notice{margin-top:14px;font-size:13px;color:#b7c6dc;background:#0f1b2a;border:1px dashed #223047;border-radius:12px;padding:10px 12px}
  footer{margin:28px 0 0;color:var(--muted);font-size:13px}
  details{background:var(--card); border:1px solid var(--ring); border-radius:14px; box-shadow:var(--shadow); padding:10px 12px; margin-top:18px}
  summary{cursor:pointer; font-weight:800}

  #primer{position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: radial-gradient(120% 120% at 50% 20%, rgba(24,39,61,.65), rgba(9,16,28,.85) 60%);
    backdrop-filter: blur(4px); z-index:999}
  #primerBtn{font-size:18px; padding:16px 22px; border-radius:16px; border:1px solid #203247; color:var(--ink);
    background: linear-gradient(180deg,#122033,#0f1b2a) padding-box, conic-gradient(from 0deg,#3bb5ff,#b9ffe6,#7fd0ff,#3bb5ff) border-box}

  /* Norwegian Whisper card */
  .whisper{display:grid; gap:8px; margin-top:12px; background:var(--card); border:1px solid var(--ring); border-radius:12px; padding:12px}
  .whisper h3{margin:0; font-size:14px}
  .row2{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .badge{border:1px solid var(--ring); border-radius:999px; padding:2px 8px; font-size:12px; color:#c9d6ea}
</style>
</head>
<body class="mode-natural">
<canvas id="stars" aria-hidden="true"></canvas>

<div id="primer" role="dialog" aria-modal="true" aria-label="Start session">
  <button id="primerBtn" class="btn primary">
    ▶ Activate Bluefire
    <span class="small" style="display:block;opacity:.8;margin-top:4px">Dark iPhone bars • Enables tones • Preloads first video</span>
  </button>
</div>

<div class="wrap">
  <header>
    <a class="brand" href="#" aria-label="Clarity Field">
      <div class="jelly" aria-hidden="true"></div>
      <div>
        <h1>Clarity Field · <span class="small">Sigrid ↔ You</span></h1>
        <div class="small">Ritual Mode • Intensity dial • 128/256 tones • Hidden R/B Burst (music only)</div>
      </div>
    </a>
    <span class="tag">consent • clarity • kindness</span>
  </header>

  <!-- CONTROL BAR -->
  <section class="tonebar" aria-label="Controls">
    <!-- Ritual toggle -->
    <div class="switch" role="tablist" aria-label="Mode">
      <button id="modeNormal" class="active" aria-selected="true">Normal</button>
      <button id="modeRitual" aria-selected="false">Ritual</button>
    </div>

    <!-- Intensity dial (1–5) -->
    <span class="pill"><strong>Intensity</strong>
      <input id="intensity" type="range" min="1" max="5" value="3" style="vertical-align:middle">
      <span id="intensityLbl" class="badge">3 · steady</span>
    </span>

    <!-- Set toggle -->
    <div class="switch" role="tablist" aria-label="Playlist set" style="margin-left:6px">
      <button id="setTracks" aria-selected="false">Tracks</button>
      <button id="setInterviews" class="active" aria-selected="true">Interviews</button>
    </div>

    <!-- Captions -->
    <span class="pill">CC:
      <select id="ccLang" aria-label="Caption language">
        <option value="en">English</option>
        <option value="no">Norwegian</option>
      </select>
      <button id="ccToggle" class="btn" style="padding:6px 10px">CC On</button>
    </span>

    <!-- Tones -->
    <span class="pill">
      <span class="row">
        <strong>Tones</strong>
        <label><input type="checkbox" id="tone128" checked> 128</label>
        <label><input type="checkbox" id="tone256" checked> 256</label>
        <label>Level <input id="toneLevel" type="range" min="0" max="100" value="68" style="vertical-align:middle"></label>
        <button id="toneToggle" class="btn" style="padding:6px 10px">On</button>
      </span>
    </span>

    <button id="burstNow" class="btn" style="padding:6px 10px" title="Hidden Red/Blue burst — music only">Clarity Burst</button>

    <span class="pill">Status: <span id="statusTone" class="badge">waiting</span></span>
  </section>

  <section class="notice">
    <strong>Ritual:</strong> arrive → 2-min settle → optional burst (Tracks only) → 8–20 min flow → 1-min close.  
    Breath cue: inhale 128 (root), exhale 256 (air). Off-ramps always visible. Kindness-first alignment.
  </section>

  <!-- FEATURED PLAYER -->
  <section class="featured" aria-live="polite">
    <div class="fp-box"><div id="fp"></div></div>
    <div class="fp-meta">
      <div>
        <div id="fpTitle" class="fp-title">—</div>
        <div id="fpCaption" class="fp-caption">Select a video from the slots below.</div>
      </div>
      <div class="fp-controls">
        <button class="btn" id="fpPlay">Play</button>
        <button class="btn" id="fpPause">Pause</button>
        <button class="btn" id="fpPrev">⟵ Prev</button>
        <button class="btn" id="fpNext">Next ⟶</button>
        <button class="btn" id="fpPiP">PiP</button>
      </div>
    </div>
  </section>

  <!-- SLOTS -->
  <section id="grid" class="grid" aria-label="Playlist slots"></section>

  <!-- Norwegian Whisper -->
  <section class="whisper" id="whisper">
    <h3>🇳🇴 Norwegian Whisper</h3>
    <div class="row2">
      <span class="badge" id="phraseTxt">—</span>
      <span class="badge" id="ipaTxt">—</span>
      <span class="badge" id="meaningTxt">—</span>
      <button class="btn" id="speakNo" style="padding:6px 10px">Speak</button>
      <span class="small" id="voiceNote" style="opacity:.8"></span>
    </div>
  </section>

  <!-- BONUS -->
  <details id="bonus">
    <summary>✨ Bonus Live Cuts</summary>
    <div id="bonusGrid" class="grid" style="margin-top:10px"></div>
  </details>

  <footer>
    <div class="notice">
      Ethics: desire = care + consent. Align to shared values (clarity, kindness, steadiness).  
      If anything feels too intense: lower volume, pause, or skip burst.
    </div>
    <p class="small">Local only (no tracking). Media © respective owners.</p>
  </footer>
</div>

<div id="prewarmBin" aria-hidden="true" style="position:absolute;left:-9999px;top:auto;width:0;height:0;overflow:hidden"></div>

<script id="yt-iframe-api" src="https://www.youtube.com/iframe_api"></script>
<script>
/* ===== Core State ===== */
const STATE_KEY = 'clarity.ritual.v10';
const state = {
  set:'interviews', fp:null, fpIndex:0, autoAdvance:true,
  ccOn:true, ccLang:'en', ctx:null, tonesOn:true, device:'default',
  audio:{}, burst:null, ritual:false, intensity:3
};

/* ===== Presets ===== */
const TRACKS = [
  {id:'cIriwVhRPVA', title:'Strangers (Official)'},
  {id:'w5x93pXSmRM', title:'Don’t Feel Like Crying'},
  {id:'1uHt2LrCSWg', title:'Sucker Punch'},
  {id:'E7lr7pU9fYA', title:'Mirror'},
  {id:'xzonQoON9eo', title:'Don’t Kill My Vibe'},
  {id:'z6A2LHGx8_A', title:'High Five'},
  {id:'udRAIF6MOm8', title:'Burning Bridges'},
  {id:'4j7LGMc9ZGU', title:'It Gets Dark'},
  {id:'hKvbaZTAQN0', title:'Dynamite (Acoustic)'},
  {id:'bNuCNZK-r5A', title:'Plot Twist'}
];
const INTERVIEWS = [
  {id:'oEC6zOhHydI', title:'Strangers — Glasto 2019 (Live)'},
  {id:'wk1NDhE_A1o', title:'Dynamite — Øya 2023'},
  {id:'cn7kW-6ZNYQ', title:'Sucker Punch — Øya 2019'},
  {id:'M4Sbee9Mj2o', title:'Strangers — BBC Live Lounge'},
  {id:'zgB5unpoEaY', title:'Strangers — Nobel 2017'},
  {id:'9rLgag0tCAU', title:'BBC Sound of 2018 — Profile'},
  {id:'O-ozpz4JD8o', title:'Abbie McCarthy — Interview'},
  {id:'XkAyr6u2Mp0', title:'How To Let Go — Interview'},
  {id:'shDlDZQoAaY', title:'Making “It Gets Dark” — BTS'},
  {id:'CeZklpxa51A', title:'Pop Around — Full Interview'}
];

/* ===== Norwegian Whisper (rotating) ===== */
const WHISPER = [
  {no:"Jeg ser deg.", ipa:"/jæɡ seːr dæɡ/", en:"I see you."},
  {no:"Tusen takk.", ipa:"/ˈtʉːsn̩ tɑk/", en:"Thank you so much."},
  {no:"Rolig pust.", ipa:"/ˈruːli ˌpʉst/", en:"Calm breath."},
  {no:"Klart hjerte.", ipa:"/klɑːrt ˈjæʈe/", en:"Clear heart."},
  {no:"La lyset inn.", ipa:"/lɑ ˈlyːsə ˈɪn/", en:"Let the light in."},
  {no:"Jeg er her.", ipa:"/jæɡ æːr hæːr/", en:"I am here."}
];

/* ===== DOM ===== */
const grid = document.getElementById('grid');
const bonusGrid = document.getElementById('bonusGrid');
const fpTitle = document.getElementById('fpTitle');
const fpCaption = document.getElementById('fpCaption');
const primer = document.getElementById('primer');
const primerBtn = document.getElementById('primerBtn');
const setTracksBtn = document.getElementById('setTracks');
const setInterBtn = document.getElementById('setInterviews');
const ccToggle = document.getElementById('ccToggle');
const ccLang = document.getElementById('ccLang');
const tone128 = document.getElementById('tone128');
const tone256 = document.getElementById('tone256');
const toneToggle = document.getElementById('toneToggle');
const toneLevel = document.getElementById('toneLevel');
const statusTone = document.getElementById('statusTone');
const burstNow = document.getElementById('burstNow');
const modeNormal = document.getElementById('modeNormal');
const modeRitual = document.getElementById('modeRitual');
const intensity = document.getElementById('intensity');
const intensityLbl = document.getElementById('intensityLbl');
/* whisper */
const phraseTxt = document.getElementById('phraseTxt');
const ipaTxt = document.getElementById('ipaTxt');
const meaningTxt = document.getElementById('meaningTxt');
const speakNo = document.getElementById('speakNo');
const voiceNote = document.getElementById('voiceNote');

/* ===== Helpers ===== */
function listBySet(){ return state.set==='tracks'?TRACKS:INTERVIEWS; }
function setBadge(txt, mode){
  statusTone.textContent = txt;
  const map = {on:['#102a21','#174a3a','#b9ffe6'], off:['#2a210f','#4a3a17','#ffd596'], wait:['#0f1b2a','#223047','#b7c6dc']};
  const [bg,bd,fg]=map[mode]||map.on; statusTone.style.background=bg; statusTone.style.borderColor=bd; statusTone.style.color=fg;
}
setBadge('waiting','wait');

/* ===== YouTube ===== */
let YT_READY=false;
window.onYouTubeIframeAPIReady = ()=>{ YT_READY=true; buildUI(); prewarmAll(); };

function buildUI(){ buildFeatured(); buildSlots(); buildBonus(); reflectButtons(); }

function buildFeatured(){
  if(!YT_READY) return;
  const L = listBySet();
  const item = L[state.fpIndex]||L[0];
  fpTitle.textContent = item? (item.title||'') : '—';
  fpCaption.textContent = item? '' : '—';
  if(state.fp){ try{ state.fp.destroy(); }catch{} }
  state.fp = new YT.Player('fp', {
    height:'100%', width:'100%', videoId: item? item.id : '',
    playerVars:{
      autoplay:0, controls:1, modestbranding:1, rel:0, playsinline:1, iv_load_policy:3,
      cc_load_policy: state.ccOn?1:0, cc_lang_pref: state.ccLang, hl: state.ccLang
    },
    events:{
      onReady: (e)=>{ try{ e.target.setPlaybackQuality('hd1080'); }catch{} setMediaSession(item); },
      onStateChange: (e)=>{
        if(e.data === YT.PlayerState.ENDED && state.autoAdvance){ nextTrack(); }
      }
    }
  });
}

function buildSlots(){
  grid.innerHTML='';
  const L=listBySet();
  for(let i=0;i<Math.max(10,L.length);i++){
    const it=L[i];
    const slot=document.createElement('article'); slot.className='slot';
    const thumb=document.createElement('div'); thumb.className='thumb';
    const img=document.createElement('img'); img.alt=it?it.title:'Empty'; if(it){ img.src=`https://i.ytimg.com/vi/${it.id}/hqdefault.jpg`; img.loading='lazy'; }
    const title=document.createElement('div'); title.className='title'; title.textContent=it?it.title:'empty';
    const snip=document.createElement('div'); snip.className='snip'; snip.textContent='';
    thumb.appendChild(img); slot.append(thumb,title,snip); grid.appendChild(slot);
    if(it){ thumb.onclick=()=>{ state.fpIndex=i; buildFeatured(); try{ state.fp.playVideo(); }catch{} }; }
  }
}
function buildBonus(){
  bonusGrid.innerHTML='';
  for(let i=0;i<6;i++){
    const it = (INTERVIEWS[i]||TRACKS[i]);
    const slot=document.createElement('article'); slot.className='slot';
    const box=document.createElement('div'); box.className='thumb';
    const img=document.createElement('img'); img.src=`https://i.ytimg.com/vi/${it.id}/hqdefault.jpg`; img.alt=it.title;
    box.appendChild(img); const title=document.createElement('div'); title.className='title'; title.textContent=it.title;
    const snip=document.createElement('div'); snip.className='snip'; snip.textContent='';
    slot.append(box,title,snip); bonusGrid.appendChild(slot);
  }
}
function prewarmAll(){
  if(!YT_READY) return;
  const L=listBySet(); const bin=document.getElementById('prewarmBin'); bin.innerHTML='';
  L.forEach((v,i)=>{ const d=document.createElement('div'); d.id='warm_'+i; bin.appendChild(d);
    new YT.Player(d.id,{height:'0',width:'0',videoId:v.id,playerVars:{autoplay:0,controls:0,rel:0,playsinline:1,iv_load_policy:3,mute:1}});
  });
}
function nextTrack(){ const L=listBySet(); let idx=state.fpIndex+1; if(idx>=Math.max(10,L.length)) idx=0; state.fpIndex=idx; buildFeatured(); setTimeout(()=>{ try{ state.fp.playVideo(); }catch{} },100); }

/* ===== Tone Engine ===== */
(function detect(){ const ua=navigator.userAgent||''; if(/iPhone/.test(ua)) state.device='iphone'; else if(/Android/.test(ua)) state.device='mobile'; })();

function initTones(){
  if(state.ctx) return;
  const AC = window.AudioContext||window.webkitAudioContext; state.ctx = new AC();

  const ctx=state.ctx, main=ctx.createGain(), merger=ctx.createChannelMerger(2), mono=ctx.createGain(), wide=ctx.createGain(), comp=ctx.createDynamicsCompressor();
  wide.gain.value=1; mono.gain.value=(state.device==='iphone'||state.device==='mobile')?0.25:0.12;
  merger.connect(wide).connect(main); mono.connect(main); comp.threshold.value=-24; comp.knee.value=12; comp.ratio.value=2; comp.attack.value=.02; comp.release.value=.25;
  main.connect(comp).connect(ctx.destination);

  const delta=(state.device==='iphone'||state.device==='mobile')?0.7:1.2;
  function pair(freq, base){
    const l=ctx.createOscillator(), r=ctx.createOscillator(); l.type=r.type='sine'; l.frequency.value=freq-delta/2; r.frequency.value=freq+delta/2;
    const gL=ctx.createGain(), gR=ctx.createGain(); gL.gain.value=gR.gain.value=base;
    const lfo=ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=(freq===128)?0.08:0.12;
    const lfoL=ctx.createGain(), lfoR=ctx.createGain(); lfoL.gain.value=(freq===128)?0.12:0.08; lfoR.gain.value=lfoL.gain.value;
    lfo.connect(lfoL).connect(gL.gain); lfo.connect(lfoR).connect(gR.gain); lfo.start();
    l.connect(gL); r.connect(gR); gL.connect(merger,0,0); gR.connect(merger,0,1);
    const mL=ctx.createGain(), mR=ctx.createGain(); mL.gain.value=mR.gain.value=base*0.5; l.connect(mL).connect(mono); r.connect(mR).connect(mono);
    l.start(); r.start(); return {gL,gR};
  }

  // base tones
  state.audio = {ctx, main, merger, mono, wide, comp,
    t128: pair(128, .16), t256: pair(256, .12),
    air: (()=>{ const n=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate), d=n.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*.02;
      const src=ctx.createBufferSource(); src.buffer=n; src.loop=true; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1500; const g=ctx.createGain(); g.gain.value=.02; src.connect(hp).connect(g).connect(main); src.start(); return {g}; })(),
    burst:null
  };
  applyIntensity(); routeTones();
}
function routeTones(){
  if(!state.audio) return; const lvl=Number(toneLevel.value)/100, on=state.tonesOn;
  state.audio.t128.gL.gain.value = state.audio.t128.gR.gain.value = (on && tone128.checked)? state._g128*lvl : 0;
  state.audio.t256.gL.gain.value = state.audio.t256.gR.gain.value = (on && tone256.checked)? state._g256*lvl : 0;
  state.audio.air.g.gain.value = on ? state._gAir*lvl : 0;
  setBadge(on?'tones on':'silent', on?'on':'off');
}

/* ===== Intensity shaping (1–5) =====
   - Gains stay safe; perception rises via depth, spread, and burst duration.
*/
function applyIntensity(){
  const i = Number(intensity.value||3);
  state.intensity = i;
  // base gains (cap loudness, increase feel via small steps)
  const g128 = {1:.12,2:.14,3:.16,4:.17,5:.18}[i];
  const g256 = {1:.09,2:.11,3:.12,4:.13,5:.14}[i];
  const gAir = {1:.014,2:.018,3:.02,4:.023,5:.026}[i];
  state._g128=g128; state._g256=g256; state._gAir=gAir;

  // burst shaping
  state._burstDepth = {1:.16,2:.20,3:.22,4:.24,5:.26}[i];
  state._burstDur   = {1:16,2:20,3:24,4:28,5:32}[i];

  intensityLbl.textContent = i + (i<=2?' · gentle': i===3?' · steady': i===4?' · deep':' · unbelievable');
  routeTones();
}

/* ===== Hidden Red/Blue Burst (music only) ===== */
function clarityBurst(){
  if(!state.ctx || state.set!=='tracks') return;
  const ctx = state.ctx, lvl=Number(toneLevel.value)/100||.68;
  // stop previous
  if(state.burst && state.burst.stop){ try{ state.burst.stop(); }catch{} }

  const bus = ctx.createGain(); bus.gain.value = 0.0;
  const red=ctx.createGain(), blue=ctx.createGain(); red.gain.value=blue.gain.value=0;
  const merger=ctx.createChannelMerger(2); red.connect(merger,0,0); blue.connect(merger,0,1);
  const out=ctx.createGain(); out.gain.value = .18*lvl; merger.connect(out).connect(state.audio.main);

  const throb=ctx.createOscillator(); throb.type='sine'; throb.frequency.value=.9;
  const amtR=ctx.createGain(), amtB=ctx.createGain(); amtR.gain.value=amtB.gain.value= state._burstDepth * lvl;
  throb.connect(amtR).connect(red.gain); throb.connect(amtB).connect(blue.gain); throb.start();

  function tone(f, gl, gr){ const l=ctx.createOscillator(), r=ctx.createOscillator(); l.type=r.type='sine'; l.frequency.value=f; r.frequency.value=f;
    const gL=ctx.createGain(), gR=ctx.createGain(); gL.gain.value=gl*lvl; gR.gain.value=gr*lvl; l.connect(gL).connect(red); r.connect(gR).connect(blue); l.start(); r.start(); return ()=>{try{l.stop();r.stop();}catch{}};}
  const stops=[ tone(64,.10,.06), tone(128,.12,.12), tone(256,.08,.10) ];

  // envelope
  const t0=ctx.currentTime+.02, dur=state._burstDur;
  bus.gain.setValueAtTime(0,t0); bus.gain.linearRampToValueAtTime(1,t0+.30);
  const tEnd=t0+dur-.8; bus.gain.setTargetAtTime(0,tEnd,.35);
  red.connect(bus); blue.connect(bus);

  const stop=()=>{ try{ throb.stop(); }catch{} stops.forEach(s=>{ try{s();}catch{} }); [red,blue,merger,out,bus].forEach(n=>{ try{ n.disconnect(); }catch{} }); state.burst=null; };
  setTimeout(stop, dur*1000+400);
  state.burst = {stop};
}

/* ===== Controls ===== */
document.getElementById('fpPlay').onclick = ()=>{ try{ state.fp.playVideo(); }catch{} };
document.getElementById('fpPause').onclick = ()=>{ try{ state.fp.pauseVideo(); }catch{} };
document.getElementById('fpNext').onclick = ()=> nextTrack();
document.getElementById('fpPrev').onclick = ()=>{ const L=listBySet(); let i=state.fpIndex-1; if(i<0) i=Math.max(10,L.length)-1; state.fpIndex=i; buildFeatured(); setTimeout(()=>{try{state.fp.playVideo();}catch{}},100); };
document.getElementById('fpPiP').onclick = async ()=>{ const v=document.querySelector('video'); if(v && v.requestPictureInPicture){ try{ await v.requestPictureInPicture(); }catch{} } };

setTracksBtn.onclick = ()=>{ state.set='tracks'; state.fpIndex=0; buildUI(); prewarmAll(); reflectButtons(); };
setInterBtn.onclick = ()=>{ state.set='interviews'; state.fpIndex=0; buildUI(); prewarmAll(); reflectButtons(); };
ccToggle.onclick = ()=>{ state.ccOn=!state.ccOn; buildFeatured(); reflectButtons(); };
ccLang.onchange = ()=>{ state.ccLang=ccLang.value; buildFeatured(); };
toneToggle.onclick = async ()=>{ if(!state.ctx){ initTones(); try{ await state.ctx.resume(); }catch{} } state.tonesOn=!state.tonesOn; routeTones(); this.textContent=state.tonesOn?'On':'Off'; };
tone128.onchange = routeTones; tone256.onchange = routeTones; toneLevel.oninput = routeTones;
burstNow.onclick = ()=> clarityBurst();
intensity.oninput = applyIntensity;
modeNormal.onclick = ()=>{ state.ritual=false; modeNormal.classList.add('active'); modeRitual.classList.remove('active'); };
modeRitual.onclick = ()=>{ state.ritual=true; modeRitual.classList.add('active'); modeNormal.classList.remove('active');
  // ritual defaults
  state.set='tracks'; state.ccOn=false; ccLang.value='en'; intensity.value='4'; applyIntensity();
  tone128.checked=true; tone256.checked=true; toneLevel.value=68; buildUI(); prewarmAll(); reflectButtons();
};

function reflectButtons(){
  setTracksBtn.classList.toggle('active', state.set==='tracks'); setTracksBtn.setAttribute('aria-selected', state.set==='tracks');
  setInterBtn.classList.toggle('active', state.set==='interviews'); setInterBtn.setAttribute('aria-selected', state.set==='interviews');
  ccToggle.textContent = state.ccOn ? 'CC On' : 'CC Off';
  // Burst gating
  burstNow.disabled = state.set!=='tracks';
  burstNow.title = state.set==='tracks' ? 'Hidden Red/Blue burst — music only' : 'Switch to Tracks for burst';
}

/* ===== Primer ===== */
primerBtn.onclick = async ()=>{
  initTones(); try{ await state.ctx.resume(); }catch{}
  setBadge('tones on','on');
  if(!state.fp) buildFeatured();
  try{ state.fp.playVideo(); }catch{}
  primer.style.display='none';
  // if Ritual + Tracks, kick a first burst after settle
  if(state.ritual && state.set==='tracks'){ setTimeout(()=> clarityBurst(), 1400); }
};

/* ===== Media Session ===== */
function setMediaSession(item){
  if(!('mediaSession' in navigator) || !item) return;
  try{
    navigator.mediaSession.metadata = new MediaMetadata({ title:item.title||'Clarity', artist:'Sigrid ↔ You', album: state.set==='tracks'?'Tracks':'Interviews',
      artwork:[{src:`https://i.ytimg.com/vi/${item.id}/hqdefault.jpg`,sizes:'480x360',type:'image/jpeg'}] });
    navigator.mediaSession.setActionHandler('previoustrack', ()=>{ document.getElementById('fpPrev').click(); });
    navigator.mediaSession.setActionHandler('nexttrack', ()=>{ document.getElementById('fpNext').click(); });
    navigator.mediaSession.setActionHandler('play', ()=>{ try{ state.fp.playVideo(); }catch{} });
    navigator.mediaSession.setActionHandler('pause', ()=>{ try{ state.fp.pauseVideo(); }catch{} });
  }catch{}
}

/* ===== Norwegian Whisper (SpeechSynthesis) ===== */
let chosen = null, noVoice = null;
function pickPhrase(){ chosen = WHISPER[Math.floor(Math.random()*WHISPER.length)]; phraseTxt.textContent=chosen.no; ipaTxt.textContent=chosen.ipa; meaningTxt.textContent=chosen.en; }
function pickVoice(){
  const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  const noVoices = voices.filter(v=> /no|nb|bokmål|norsk/i.test(v.lang+v.name));
  noVoice = noVoices[0] || voices.find(v=>/en/i.test(v.lang)) || null;
  voiceNote.textContent = noVoice ? `voice: ${noVoice.name}` : 'voice unavailable (device)';
}
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = ()=>{ pickVoice(); };
  pickVoice();
}
pickPhrase();
speakNo.onclick = ()=>{
  if(!('speechSynthesis' in window) || !chosen) return;
  const u = new SpeechSynthesisUtterance(chosen.no);
  if(noVoice) u.voice = noVoice;
  u.rate = .98; u.pitch = 1.02; u.lang = (noVoice && noVoice.lang) || 'no-NO';
  // gentle ducking of tones while speaking
  const g = state.audio?.main; const old = g? g.gain?.value : null;
  if(g && g.gain){ try{ g.gain.setTargetAtTime((old||1)*0.8, state.ctx.currentTime, .02); }catch{} }
  u.onend = ()=>{ if(g && g.gain && old!=null){ try{ g.gain.setTargetAtTime(old, state.ctx.currentTime, .05); }catch{} } pickPhrase(); };
  speechSynthesis.speak(u);
};

/* ===== Stars ===== */
(function stars(){
  const c=document.getElementById('stars'); const dpr=Math.max(1,window.devicePixelRatio||1);
  const x=c.getContext('2d'); let flakes=[], mouseY=0, scrollY=0;
  function size(){ c.width=innerWidth*dpr; c.height=innerHeight*dpr; x.setTransform(dpr,0,0,dpr,0,0); }
  function seed(N=120){ flakes=new Array(N).fill(0).map(()=>({x:Math.random()*innerWidth,y:-10-Math.random()*innerHeight,r:0.6+Math.random()*1.8,s:.35+Math.random()*1,o:.35+Math.random()*.45,l:.2+Math.random()*.8})); }
  function draw(){
    x.clearRect(0,0,innerWidth,innerHeight);
    const par=(scrollY*0.12+(mouseY-innerHeight/2)*0.02);
    for(const f of flakes){ f.y+=f.s+par*0.0015; f.x+=Math.sin((f.y+par)*.01)*f.l; if(f.y>innerHeight+10){ f.y=-10; f.x=Math.random()*innerWidth; }
      x.globalAlpha=f.o; x.beginPath(); x.arc(f.x,f.y,f.r,0,Math.PI*2); x.fillStyle="rgba(127,208,255,.55)"; x.fill(); }
    requestAnimationFrame(draw);
  }
  window.addEventListener('resize', ()=>{ size(); seed(flakes.length); });
  window.addEventListener('mousemove', e=>{ mouseY=e.clientY; });
  window.addEventListener('scroll', ()=>{ scrollY=window.scrollY||0; });
  size(); seed(); draw();
})();
</script>
</body>
</html>
